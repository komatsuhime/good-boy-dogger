<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Good Boy Dogger</title>
    <!-- by Carla Faroldi -->
    <script src="js/ga.js"></script>
    <script src="js/plugins.js"></script>
</head>

<body>
    <script>
    var doggerWidth = 480;
    var doggerHeight = 480;
    var dogger = ga(doggerWidth, doggerHeight, setup, ["img/dogger.png"]);
    dogger.start();

    var dog, stuff, obstacle, barksLeft, bark, maxSprites, alerta, gameScene, GameOverScene, occupiedX, occupiedY, size, stuffAmount, tiles;
    var win = 0;

    alerta = dogger.text(" ", "20px Verdana", "fuchsia", 120, 120);
    alerta.x = 120;
    alerta.y = 120;

    function setup() {
        dogger.canvas.style.border = "1px black dashed";
        dogger.backgroundColor = "white";

        size = 48;
        stuffAmount = 10;
        maxSprites = doggerWidth/size;
        maxSprites -= 1; // so I can get a random number from 0 to maxSprites-1

        gameScene = dogger.group();
        dog = dogger.sprite("img/dogger.png");
        dog.x = dogger.canvas.width / 2 - dog.width;
        dog.y = dogger.canvas.height / 2 - dog.height;
        gameScene.addChild(dog);

        dog.interactive = true;
        // dog.draggable = true;

        // bark = dogger.keyboard(98);
        // bark.press = function() {
        //     console.log(bark);
        // };

        stuffs = [];
        for (var i = 0; i < stuffAmount; i++) {
            stuff = dogger.rectangle(size, size, "orange");
            stuff.x = size * (dogger.randomInt(0, maxSprites));
            stuff.y = size * (dogger.randomInt(0, maxSprites));
            stuffs.push(stuff);
            gameScene.addChild(stuff);
        }

        occupiedX = stuffs.map(function(s) { return s.x; });
        occupiedY = stuffs.map(function(s) { return s.y; });
        // console.log(occupiedX + " - " + occupiedY);

        obstacles = [];

        dogger.fourKeyController(dog, size, 38, 39, 40, 37);
        dogger.state = play;
    }

    function play() {
        dogger.move(dog);
        dogger.contain(dog, dogger.stage.localBounds);

        if (dogger.key.leftArrow.isDown || dogger.key.upArrow.isDown || dogger.key.rightArrow.isDown || dogger.key.downArrow.isDown) {
            obstacle = dogger.rectangle(size, size, "grey");

            var positionX = size * (dogger.randomInt(0, maxSprites));
            var positionY = size * (dogger.randomInt(0, maxSprites));
            // console.log(occupied(occupiedX, positionX));
            obstacle.x = occupied(occupiedX, positionX);
            obstacle.y = occupied(occupiedY, positionY);
            // occupiedX.push(obstacle.x);
            // occupiedY.push(obstacle.y);
            obstacles.push(obstacle);
            gameScene.addChild(obstacle);

            // console.log(obstacle.x + " - " + obstacle.y);

            dogger.pause();
            dogger.wait(125, resume);
        }

        function resume() {
            dogger.resume();
        }

        function occupied(a, v) {
            if (a.indexOf(v) == -1) {
                console.log(v + " siiiiii");
                return v;
            } else {
                v = size * (dogger.randomInt(0, maxSprites));
                console.log(v + " eeh");
                occupied(a, v);
            }
        }

        stuffs = stuffs.filter(function(stuff) {
            if (dogger.hit(dog, stuff)) {
                win += 1;
                gameScene.remove(stuff);
                return false;
            } else {
                return true;
            }
        });

        if (win == stuffAmount) {
            alerta.content = "You won!";
        }

        //FIX!!
        if (dogger.key.space.isDown) {
            obstacles = obstacles.filter(function(obstacle) {
                gameScene.remove(obstacle);
                return false;
            });
        }

        var obstacleHit = false;

        obstacles.forEach(function(obstacle) {
            if (dogger.hitTestRectangle(dog, obstacle)) {
                obstacleHit = true;
            } else {
                // obstacleHit = false;
            }
        });

        if (obstacleHit == true) {
            //moves to the left
            if (dog.vx < 0) {
                dog.x += size;
            }
            //moves to the right
            if (dog.vx > 0) {
                dog.x -= size;
            }
            //moves up
            if (dog.vy < 0) {
                dog.y += size;
            }
            //moves down
            if (dog.vy > 0) {
                dog.y -= size;
            }
        }
    }
    </script>
    <p>Move and pick up the orange squares to win. You're a dog, by the way.</p>
    <ul>
        <li>Arrow keys: move</li>
        <li>Spacebar: bark (remove all obstacles)</li>
    </ul>
</body>

</html>