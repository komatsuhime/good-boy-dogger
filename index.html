<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Good Boy Dogger</title>
    <!-- by Carla Faroldi -->
    <script src="js/ga.js"></script>
    <script src="js/plugins.js"></script>
</head>

<body>
    <script>
    var dogger = ga(480, 480, setup);
    dogger.start();

    var dog, stuff, obstacle, barksLeft, bark, alerta, win, gameScene, GameOverScene;
    var dogMoved = false;
    win = 0;
    var test = 0;


    // alerta = dogger.text(".", "20px Verdana", "black", 120, 120);
    // alerta.x = 120;
    // alerta.y = 120;

function setup() {
        dogger.canvas.style.border = "1px black dashed";
        dogger.backgroundColor = "white";

        gameScene = dogger.group();
        dog = dogger.rectangle(24, 24, "pink");
        dog.x = dogger.canvas.width / 2 - dog.width;
        dog.y = dogger.canvas.height / 2 - dog.height;
        gameScene.addChild(dog);

        bark = dogger.keyboard(98);
           bark.press = function() {
                 console.log(bark);
            };

        stuffs = [];
        for (var i = 0; i < 5; i++) {
            stuff = dogger.rectangle(24, 24, "orange");
            stuff.x = 24 * (dogger.randomInt(0, 19));
            stuff.y = 24 * (dogger.randomInt(0, 19));
            stuffs.push(stuff);
            gameScene.addChild(stuff);
        }

        obstacles = [];

        dogger.fourKeyController(dog, 24, 38, 39, 40, 37);
        dogger.state = play;
}

function play() {
        dogger.move(dog);
        dogger.contain(dog, dogger.stage.localBounds);

        if (dogger.key.leftArrow.isDown || dogger.key.upArrow.isDown || dogger.key.rightArrow.isDown || dogger.key.downArrow.isDown) {
            obstacle = dogger.rectangle(24, 24, "grey");

            var occupiedX = stuffs.map(function(s) { return s.x });
            var occupiedY = stuffs.map(function(s) { return s.y });
            var positionX = 24 * (dogger.randomInt(0, 19));
            var positionY = 24 * (dogger.randomInt(0, 19));
            obstacle.x = occupied(occupiedX, positionX);
            obstacle.y = occupied(occupiedY, positionY);

            obstacles.push(obstacle);
            gameScene.addChild(obstacle);
            dogger.pause();
            dogger.wait(125, resume);
        }

        function resume() {
            dogger.resume();
        }

        function occupied(a, v) {
            if (a.indexOf(v) == -1) {
                return v;
            } else {
                v = 24 * (dogger.randomInt(0, 19));
                occupied(a, v);
            }
        }

        stuffs = stuffs.filter(function(stuff) {
            if (dogger.hit(dog, stuff)) {
                win += 1;
                gameScene.remove(stuff);
                return false;
            } else {
                return true;
            }
        });

        if (win == 5) {
            // WON!
        }

        //FIX!!
        if (dogger.key.space.isDown) {
            obstacles = obstacles.filter(function(obstacle){
                gameScene.remove(obstacle);
                return false;
            });
        }

        var obstacleHit = false;

        obstacles.forEach(function(obstacle) {
            if (dogger.hitTestRectangle(dog, obstacle)) {
                obstacleHit = true;
            } else {
                // obstacleHit = false;
            }
        });

        if (obstacleHit == true) {
            //moves to the left
            if (dog.vx < 0) {
                dog.x += 24;
            }
            //moves to the right
            if (dog.vx > 0) {
                dog.x -= 24;
            }
            //moves up
            if (dog.vy < 0) {
                dog.y += 24;
            }
            //moves down
            if (dog.vy > 0) {
                dog.y -= 24;
            }
        }
    }
    </script>
</body>

</html>